<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      lang="es">

    <f:view>
        <f:metadata>
            <f:event type="preRenderView" listener="#{usuarioBean.verifSesion}" />
        </f:metadata>

        <h:head>
            <title>Nueva Salida de Inventario</title>
            <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

            <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&amp;display=swap" rel="stylesheet"/>
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
            <h:outputStylesheet library="css" name="dashboardusuarios.css" />

            <style>
                :root {
                    --primary: #16a34a;
                    --primary-dark: #15803d;
                    --secondary: #6b7280;
                    --secondary-dark: #4b5563;
                    --danger: #dc3545;
                    --danger-dark: #c82333;
                    --light: #f8fafc;
                    --dark: #1e293b;
                    --gray: #64748b;
                    --border: #e2e8f0;
                    --shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
                    --radius: 12px;
                }

                body {
                    font-family: 'Montserrat', sans-serif;
                    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
                    margin: 0;
                    padding: 0;
                    min-height: 100vh;
                    color: var(--dark);
                }

                .card {
                    background: white;
                    border-radius: var(--radius);
                    padding: 40px;
                    box-shadow: var(--shadow);
                    max-width: 900px;
                    margin: 40px auto;
                    border: 1px solid var(--border);
                }

                h1 {
                    color: var(--dark);
                    font-size: 28px;
                    font-weight: 700;
                    margin-bottom: 10px;
                    text-align: center;
                }

                .card > p {
                    text-align: center;
                    color: var(--gray);
                    margin-bottom: 30px;
                    font-size: 15px;
                }

                .form-grid {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 25px;
                    margin-bottom: 30px;
                }

                .form-group {
                    display: flex;
                    flex-direction: column;
                }

                label {
                    display: block;
                    margin-bottom: 8px;
                    font-weight: 600;
                    color: var(--dark);
                    font-size: 14px;
                }

                .required {
                    color: var(--danger);
                }

                .ui-selectonemenu, .ui-inputfield, .ui-inputtextarea {
                    width: 100% !important;
                    border: 1px solid var(--border) !important;
                    border-radius: 8px !important;
                    padding: 12px 15px !important;
                    font-family: 'Montserrat', sans-serif !important;
                    transition: all 0.3s ease !important;
                    background: white !important;
                }

                .ui-selectonemenu:focus, .ui-inputfield:focus, .ui-inputtextarea:focus {
                    border-color: var(--primary) !important;
                    box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.1) !important;
                    outline: none !important;
                }

                .ui-inputtextarea {
                    resize: vertical !important;
                    min-height: 100px !important;
                }

                .ui-outputlabel {
                    display: block !important;
                    width: 100% !important;
                    padding: 12px 15px !important;
                    border: 1px solid var(--border) !important;
                    border-radius: 8px !important;
                    background: #f8fafc !important;
                    font-family: 'Montserrat', sans-serif !important;
                    color: var(--gray) !important;
                }

                #stockInfo {
                    margin-top: 8px;
                    padding: 8px 12px;
                    background: #f0fdf4;
                    border: 1px solid #bbf7d0;
                    border-radius: 6px;
                    font-size: 13px;
                    color: var(--primary-dark);
                    font-weight: 600;
                }

                .action-buttons {
                    display: flex;
                    justify-content: center;
                    gap: 15px;
                    margin-top: 30px;
                    flex-wrap: wrap;
                }

                .ui-button {
                    font-family: 'Montserrat', sans-serif !important;
                    font-weight: 600 !important;
                    border: none !important;
                    border-radius: 8px !important;
                    padding: 12px 24px !important;
                    transition: all 0.3s ease !important;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.1) !important;
                    min-width: 160px;
                }

                .ui-button:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 4px 8px rgba(0,0,0,0.15) !important;
                }

                .btn-primary {
                    background: linear-gradient(135deg, var(--primary), var(--primary-dark)) !important;
                    color: white !important;
                }

                .btn-secondary {
                    background: linear-gradient(135deg, var(--secondary), var(--secondary-dark)) !important;
                    color: white !important;
                }

                /* Diálogo de éxito */
                .ui-dialog {
                    border-radius: var(--radius) !important;
                    box-shadow: var(--shadow) !important;
                    border: 1px solid var(--border) !important;
                }

                .ui-dialog-titlebar {
                    background: white !important;
                    border-bottom: 1px solid var(--border) !important;
                    border-radius: var(--radius) var(--radius) 0 0 !important;
                }

                .ui-dialog-content {
                    padding: 20px !important;
                }

                /* Responsive */
                @media (max-width: 768px) {
                    .card {
                        margin: 20px;
                        padding: 25px;
                    }

                    .form-grid {
                        grid-template-columns: 1fr;
                        gap: 20px;
                    }

                    .action-buttons {
                        flex-direction: column;
                        align-items: center;
                    }

                    .ui-button {
                        width: 100%;
                        max-width: 300px;
                    }
                }
            </style>
        </h:head>

        <h:body>
            <p:growl id="mensajes" showDetail="true" life="4000" />

            <h:form id="formSalida">
                <div class="card">
                    <h1>Registrar Nueva Salida de Inventario</h1>
                    <p>Complete los datos a continuación para registrar la salida de productos.</p>

                    <div class="form-grid">
                        <!-- Selección de Producto -->
                        <div class="form-group">
                            <label>Producto <span class="required">*</span></label>
                            <p:selectOneMenu id="selectProducto" value="#{salidasInventarioBean.salida.idInventario}" required="true" requiredMessage="Seleccione un producto">
                                <f:selectItem itemLabel="--Seleccione un producto--" itemValue="" />
                                <f:selectItems value="#{salidasInventarioBean.listaInventario}" var="inv"
                                               itemLabel="#{inv.nombre}" itemValue="#{inv.id}" />
                                <p:ajax update="stockInfo" listener="#{salidasInventarioBean.cargarInventario}" />
                            </p:selectOneMenu>

                            <p:outputPanel id="stockInfo">
                                <h:outputText value="Stock disponible: #{salidasInventarioBean.salida.inventario != null ? salidasInventarioBean.salida.inventario.stockActual : 0}" />
                            </p:outputPanel>
                        </div>

                        <!-- Tipo de Salida -->
                        <div class="form-group">
                            <label>Tipo de Salida <span class="required">*</span></label>
                            <p:selectOneMenu id="tipoSalida" value="#{salidasInventarioBean.salida.idTipoSalida}" required="true" requiredMessage="Seleccione tipo de salida">
                                <f:selectItem itemLabel="--Seleccione tipo de salida--" itemValue="" />
                                <f:selectItems value="#{salidasInventarioBean.listaTiposSalida}" var="tipo"
                                               itemLabel="#{tipo.nombre}" itemValue="#{tipo.id}" />
                            </p:selectOneMenu>
                        </div>

                        <!-- Cantidad -->
                        <div class="form-group">
                            <label>Cantidad <span class="required">*</span></label>
                            <p:inputText id="cantidad" value="#{salidasInventarioBean.salida.cantidad}" required="true"
                                         requiredMessage="Ingrese la cantidad" />
                        </div>

                        <!-- Observaciones -->
                        <div class="form-group">
                            <label>Observaciones</label>
                            <p:inputTextarea value="#{salidasInventarioBean.salida.observaciones}" rows="4" cols="30" placeholder="Ej: Venta a cliente, uso interno, etc." />
                        </div>

                        <!-- Usuario (solo lectura) -->
                        <div class="form-group">
                            <label>Usuario Responsable</label>
                            <p:outputLabel value="#{sessionScope.user}" />
                            <h:inputHidden value="#{salidasInventarioBean.salida.idUsuario}" />
                        </div>

                        <!-- Fecha de Salida (solo lectura) -->
                        <div class="form-group">
                            <label>Fecha de Salida</label>
                            <p:inputText value="#{salidasInventarioBean.salida.fechaSalida}" disabled="true"/>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <p:commandButton value="Registrar Salida" action="#{salidasInventarioBean.registrarSalida}"
                                         update="mensajes formSalida" styleClass="btn-primary" icon="pi pi-save" />

                        <p:commandButton value="Limpiar Formulario" 
                                         action="#{salidasInventarioBean.limpiarFormulario}"
                                         update="formSalida" 
                                         styleClass="btn-secondary" 
                                         icon="pi pi-refresh" 
                                         immediate="true" />

                        <p:button value="Cancelar" outcome="/administrador/inventario.xhtml" styleClass="btn-secondary" icon="pi pi-times"/>
                    </div>

                </div>
            </h:form>

            <!-- Diálogo de éxito -->
            <p:dialog header="Salida Registrada" widgetVar="dlgExito" modal="true" draggable="false" resizable="false">
                <div style="text-align: center; padding: 20px;">
                    <i class="fas fa-check-circle" style="font-size: 48px; color: #22c55e; margin-bottom: 15px;"></i>
                    <h3 style="color: #22c55e; margin-bottom: 10px;">¡Salida registrada exitosamente!</h3>
                    <p>La salida de inventario ha sido registrada correctamente.</p>
                    <div style="margin-top: 20px;">
                        <p:button value="Registrar Otra Salida" onclick="PF('dlgExito').hide();" styleClass="btn-primary" icon="pi pi-plus"/>
                        <p:button value="Volver al Inventario" outcome="/administrador/inventario.xhtml" styleClass="btn-secondary" icon="pi pi-arrow-left"/>
                    </div>
                </div>
            </p:dialog>
        </h:body>
    </f:view>
</html>